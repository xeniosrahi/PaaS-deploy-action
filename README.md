# PaaS-deploy-action
A Github action for deploying PaaS on Edge / Home PCs

# CapRover + Cloudflared + IPv6 + GPU/TPU + Tailscale (Tunneled by Default)

A batteries-included GitHub repo to bootstrap and operate a CapRover cluster on Ubuntu 24.04 with:

- **Cloudflare Tunnel** (all apps tunneled by default)
- Optional **public IPv6 + Let‚Äôs Encrypt** (direct AAAA)
- **Docker IPv6** with autogenerated ULA on all nodes
- **Tailscale** (optional, exit-node capable)
- **GPU/TPU prep** (NVIDIA, AMD, Coral) + **node labels** and **placement rules**
- Turnkey **Immich** deployment (quota volume + extra mounts + GPU ML placement)
- **Per-app IPv6** network (ipvlan) and **tunnel deny/allow** control
- **Build on GitHub, Deploy from self-hosted** to avoid tunnel upload limits
- **.env secrets masking** during env sync
- **Rollout/Rollback** workflow to pin images and revert quickly


## üìÇ Repository Layout

```text
.github/workflows/
‚îú‚îÄ caprover-bootstrap.yml          # Manager bootstrap (tunneled + optional IPv6/LE)
‚îú‚îÄ caprover-node-join.yml          # Join nodes: IPv6, GPU/TPU, Tailscale, auto-label
‚îú‚îÄ caprover-node-labels.yml        # Manual labels
‚îú‚îÄ immich-deploy.yml               # Immich deploy (quota + mounts + GPU placement)
‚îú‚îÄ caprover-app-placement-patch.yml# Placement constraints (+ optional ipv6-public)
‚îú‚îÄ cloudflared-tunnel-toggle.yml   # Per-FQDN tunnel deny/allow
‚îú‚îÄ ipv6-pool-setup.yml             # Create ipv6-public (ipvlan) + ndppd
‚îú‚îÄ app-build-and-deploy.yml        # Build on GitHub, deploy on self-hosted
‚îú‚îÄ caprover-app-init-and-env.yml   # App init + healthcheck + env sync (with denylist masking)
‚îî‚îÄ caprover-rollout-rollback.yml   # Pin image (rollout) & revert (rollback)

apps/apex-welcome/
‚îú‚îÄ Dockerfile
‚îú‚îÄ index.html
‚îî‚îÄ captain-definition

PROJECT_DESCRIPTION_FOR_LLM.md
README.md
```

## üîë Setup (once)

1. **Secrets**  
   Add in *Repo ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions*:

   - Required: `CAPROVER_PASSWORD`, `CF_TUNNEL_TOKEN`
   - Optional: `TAILSCALE_AUTHKEY`, `MANAGER_SSH_KEY`, `SSH_KNOWN_HOSTS`
   - For non-GHCR registries: `REGISTRY_USERNAME`, `REGISTRY_PASSWORD`
   - Convenience: `ROOT_DOMAIN`, `APPS_WILDCARD_SUBDOMAIN`, `CAPTAIN_SUBDOMAIN`

2. **Bootstrap manager**  
   Run **`caprover-bootstrap.yml`**:
   - Sets up tunnel for `captain.<root>` and `*.apps.<root>`
   - `EXPOSE_PUBLIC_IPV6=true` ‚Üí opens 80/443 on IPv6 + Let‚Äôs Encrypt

3. **Join workers**  
   Run **`caprover-node-join.yml`** per node:
   - Configure `GPU_TYPE` and `APPLY_GPU_PREP=true` if needed
   - Nodes are auto-labeled (e.g., `gpu=nvidia`)

## üöÄ Deploy Flow

### A. Initialize app + env
Use **`caprover-app-init-and-env.yml`** to:

- Create app if missing  
- Apply health check + base config  
- Sync `.env` from another repo  

‚ö†Ô∏è **Secrets masking:** keys matching these patterns are skipped:  
`SECRET`, `_SECRET$`, `TOKEN`, `PASSWORD`, `PASS$`, `API_KEY`, `PRIVATE`, `CERT`, `AWS_`, `GCP_`, `AZURE_`


### B. Build on GitHub, deploy from self-hosted
Use **`app-build-and-deploy.yml`**:

- Builds multi-arch images on **GitHub-hosted runners**
- Pushes to registry (GHCR by default)
- Self-hosted runner deploys to CapRover by setting `dockerImage`  
  ‚Üí avoids the **100MB Cloudflare tunnel upload limit**
- Optional: `BUILD_ON_SELF_HOSTED_TOO=true` clones and builds directly on your node


### C. Placement constraints
Use **`caprover-app-placement-patch.yml`**:

- Constrain services to labeled nodes (e.g., `gpu=nvidia`)
- Optionally attach `ipv6-public` network + fixed IPv6 per service


### D. Rollout / Rollback
Use **`caprover-rollout-rollback.yml`**:

- **Rollout**:  
  - `MODE=rollout` + `IMAGE_REF=ghcr.io/org/app:1.2.3`  
  - Saves current image to env (`PREV_IMAGE`)  
  - Pins app to new image
- **Rollback**:  
  - `MODE=rollback`  
  - Reads `PREV_IMAGE` from app env  
  - Re-pins to it

üí° You can customize `SET_PREV_ENV_KEY` (e.g., `PREV_IMAGE_STABLE`) for multiple rollback slots.


## üåê IPv6 & Tunnel Controls

- Default: **all apps tunneled** ‚Üí `*.apps.<root>` + `captain.<root>`
- Enable **public IPv6** by setting `EXPOSE_PUBLIC_IPV6=true`
- Per-FQDN opt-out: run **`cloudflared-tunnel-toggle.yml`** to deny tunnel ‚Üí serve via direct IPv6 only


## üñºÔ∏è Immich One-Click

- Quota volume defined by `IMMICH_STORAGE_GB`  
- Extra mounts via `IMMICH_EXTRA_MOUNTS`  
- ML service scheduled only on GPU-labeled nodes with GPU device reservation


## üõ† Troubleshooting

- **Tunnel:** `systemctl status cloudflared`, check `/etc/cloudflared/config.yml`
- **IPv6:** verify with `ip -6 addr`; for per-app IPv6 ensure routed `/64` + `ndppd`
- **GPU:** NVIDIA nodes need `nvidia-container-toolkit`; AMD/Coral prep included
- **CapRover:** re-run any workflow ‚Äî they‚Äôre idempotent


## üìú License

MIT
